#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import os
import subprocess
import time
import signal

# Add src to path so we can import modules
base_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.append(os.path.join(base_dir, 'src'))

import sovereign_ctl as ctl

def scan_now():
    """Performs a one-time synchronous scan of the system."""
    print("üîç Scanning all active processes...")
    try:
        # We run the monitor script with a special flag or just parse its output?
        # Simpler: We'll import the logic directly or run a one-off check script.
        # For robustness/separation, let's run the monitor script with a 'scan-once' flag.
        # But monitor script acts as a daemon. 
        # Let's verify via the PID logs if a threat was *just* detected, 
        # OR better: run a dedicated audit script. 
        
        # Let's run a quick custom scan using psutil directly here for speed
        import psutil
        threats = []
        suspicious = []
        
        target_names = ['chrome', 'brave', 'edge', 'arc', 'opera', 'vivaldi']
        critical_flags = ['--remote-debugging-port', '--load-extension']
        suspicious_flags = ['--disable-web-security', '--no-sandbox', '--headless']
        
        for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
            try:
                name = proc.info['name']
                if not name: continue
                
                if any(t in name.lower() for t in target_names):
                    cmdline = proc.cmdline()
                    for arg in cmdline:
                        if any(flag in arg for flag in critical_flags):
                            threats.append(f"{name} (PID: {proc.info['pid']}) -> {arg}")
                        elif any(flag in arg for flag in suspicious_flags):
                            suspicious.append(f"{name} (PID: {proc.info['pid']}) -> {arg}")
            except:
                continue
                
        if threats:
            print("\n‚ùå COMPROMISED: Active threats detected!")
            for t in threats:
                print(f"   - {t}")
            sys.exit(1)
        elif suspicious:
            print("\n‚ö†Ô∏è  SECURE (With Warnings): No critical threats, but suspicious activity detected.")
            for s in suspicious:
                print(f"   - {s}")
            sys.exit(0)
        else:
            print("\n‚úÖ SECURE: No hostile browser processes found.")
            sys.exit(0)
            
    except ImportError:
        print("[!] psutil not found in system python. Run via ./venv/bin/python3")

def main():
    if len(sys.argv) < 2:
        print("Usage: ./sovereign {start|stop|restart|status|dev|secure|scan|dashboard|report|bootstrap|clean}")
        sys.exit(1)
        
    cmd = sys.argv[1].lower()
    
    if cmd == 'start':
        ctl.start()
    elif cmd == 'stop':
        ctl.stop()
    elif cmd == 'restart':
        ctl.stop()
        time.sleep(1)
        ctl.start()
    elif cmd == 'status':
        ctl.status()
    elif cmd == 'clean':
        ctl.clean_logs()
    elif cmd == 'uninstall':
        ctl.uninstall_wizard()
    elif cmd == 'dev':
        ctl.dev_mode()
    elif cmd == 'secure':
        ctl.secure_mode()
    elif cmd == 'dashboard':
        ctl.dashboard()
    elif cmd == 'report':
        ctl.report()
    elif cmd == 'bootstrap':
        ctl.bootstrap()
    elif cmd == '2fa':
        ctl.setup_2fa()
    elif cmd == 'logs':
        ctl.view_logs()
    elif cmd == 'authorize':
        if ctl.authorize_action():
            secret = ctl.get_secret()
            with open(ctl.SAFE_MODE_FILE, "w") as f:
                f.write(secret)
            print("\nüõ°Ô∏è  AUTHORIZATION GRANTED: Sovereign Guard entering Safe Mode for 60 seconds.")
            print("   You may now copy/paste sensitive fingerprints or keys.")
            
            def auto_expire():
                time.sleep(60)
                if os.path.exists(ctl.SAFE_MODE_FILE):
                    os.remove(ctl.SAFE_MODE_FILE)
                
            import threading
            threading.Thread(target=auto_expire, daemon=True).start()
    elif cmd == 'scan':
        # Re-launch scan using the VENV python where psutil lives
        if sys.executable != os.path.abspath(ctl.VENV_PYTHON):
            try:
                subprocess.check_call([ctl.VENV_PYTHON, __file__, "scan"])
            except subprocess.CalledProcessError:
                sys.exit(1)
        else:
            scan_now()
    else:
        print(f"Unknown command: {cmd}")
        print("Usage: ./sovereign {start|stop|restart|status|dev|secure|scan|logs|dashboard|report|bootstrap|2fa|authorize|clean}")

if __name__ == "__main__":
    main()
